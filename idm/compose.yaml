services:
  prestart:
    image: alpine:latest
    restart: no
    volumes:
      - data:/data:rw
      - ./prestart.sh:/prestart.sh:ro
    command: /prestart.sh

  kanidm:
    image: kanidm/server:latest
    restart: unless-stopped
    user: 100:100
    depends_on:
      prestart:
        condition: service_completed_successfully
    networks:
      - default
      - traefik
    volumes:
      - data:/data:rw
      - ./config/${RTCNET_HOST:?error}:/config:ro
      - /var/lib/certs/idm:/cert:ro
    environment:
      KANIDM_CONFIG: /config/server.toml
    labels:
      traefik.enable: 'true'
      traefik.http.services.kanidm.loadbalancer.server.port: '8443'
      traefik.http.services.kanidm.loadbalancer.server.scheme: https
      traefik.http.services.kanidm.loadbalancer.serverstransport: idm-${RTCNET_HOST:?error}@file
      traefik.http.routers.kanidm.rule: Host(`${RTCNET_HOST:?error}.idm.rtcid.ru`)

networks:
  default:
    enable_ipv6: true
  
  traefik:
    external: true

volumes:
  data:
